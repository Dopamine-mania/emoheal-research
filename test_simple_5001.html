<!DOCTYPE html>
<html>
<head>
    <title>æç®€éŸ³ä¹ç–—æ„ˆæµ‹è¯• - 5001ç«¯å£</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; padding: 20px; background: #f0f0f0; }
        .container { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 10px; }
        input, button { width: 100%; padding: 10px; margin: 10px 0; font-size: 16px; }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        #result { margin-top: 20px; padding: 20px; background: #e8f5e9; border-radius: 5px; }
        .error { background: #ffebee !important; color: #c62828; }
        video { width: 100%; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ éŸ³ä¹ç–—æ„ˆç³»ç»Ÿ</h1>
        <p>å½“å‰å°è¯•è¿æ¥ç«¯å£ï¼š<strong id="port">5001</strong></p>
        
        <button onclick="testPort(5000)">æµ‹è¯•5000ç«¯å£</button>
        <button onclick="testPort(5001)">æµ‹è¯•5001ç«¯å£</button>
        
        <input type="text" id="emotion" placeholder="è¾“å…¥æ‚¨çš„æƒ…ç»ªï¼Œå¦‚ï¼šå¤´æ™•æƒ³å" />
        <button onclick="searchMusic()">æŸ¥æ‰¾ç–—æ„ˆéŸ³ä¹</button>
        
        <div id="result" style="display:none;"></div>
        <video id="video" controls style="display:none;"></video>
    </div>

    <script>
        let currentPort = 5001;
        
        function testPort(port) {
            currentPort = port;
            document.getElementById('port').textContent = port;
            
            fetch(`http://127.0.0.1:${port}/api/health`)
                .then(res => res.json())
                .then(data => {
                    showResult(`ç«¯å£ ${port} è¿æ¥æˆåŠŸï¼`, false);
                })
                .catch(err => {
                    showResult(`ç«¯å£ ${port} è¿æ¥å¤±è´¥ï¼š${err.message}`, true);
                });
        }
        
        function searchMusic() {
            const emotion = document.getElementById('emotion').value;
            if (!emotion) {
                showResult('è¯·è¾“å…¥æƒ…ç»ª', true);
                return;
            }
            
            showResult('æœç´¢ä¸­...', false);
            
            fetch(`http://127.0.0.1:${currentPort}/api/music/search-text`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: emotion,
                    settings: { duration: '3min', max_results: 1 }
                })
            })
            .then(res => res.json())
            .then(data => {
                console.log('å“åº”æ•°æ®:', data);
                if (data.success && data.data?.segments?.length > 0) {
                    const video = data.data.segments[0];
                    const videoPath = video.url || video.video_path;
                    if (videoPath) {
                        const videoUrl = `http://127.0.0.1:${currentPort}/api/video/${videoPath}`;
                        document.getElementById('video').src = videoUrl;
                        document.getElementById('video').style.display = 'block';
                        showResult('æ‰¾åˆ°è§†é¢‘ï¼', false);
                    } else {
                        showResult('æœªæ‰¾åˆ°è§†é¢‘è·¯å¾„', true);
                    }
                } else {
                    showResult('æœªæ‰¾åˆ°åŒ¹é…çš„éŸ³ä¹', true);
                }
            })
            .catch(err => {
                showResult(`è¯·æ±‚å¤±è´¥ï¼š${err.message}`, true);
            });
        }
        
        function showResult(msg, isError) {
            const result = document.getElementById('result');
            result.textContent = msg;
            result.style.display = 'block';
            result.className = isError ? 'error' : '';
        }
        
        // é¡µé¢åŠ è½½æ—¶æµ‹è¯•é»˜è®¤ç«¯å£
        window.onload = () => testPort(5001);
    </script>
</body>
</html>